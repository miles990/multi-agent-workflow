# E-AGT-001: Agent 超時

## 錯誤資訊

| 欄位 | 值 |
|------|-----|
| 錯誤碼 | E-AGT-001 |
| 名稱 | Agent 超時 |
| 嚴重度 | HIGH |
| 類別 | Agent 執行 |

## 說明

當 Agent（視角）執行時間超過預設超時限制（預設 5 分鐘）時，系統會觸發此錯誤。超時機制用於防止無限等待和資源浪費。

## 常見場景

### 場景 1：測試套件過大

**狀況**：在 IMPLEMENT 階段，TDD 守護者視角執行測試套件時超時。

**原因**：
- 測試數量過多
- 單個測試執行時間過長
- 測試包含大量 I/O 操作

**解決方案**：
1. 檢查測試套件大小：`npm test -- --listTests`
2. 識別慢速測試：`npm test -- --verbose`
3. 拆分測試套件或使用並行測試

### 場景 2：外部依賴緩慢

**狀況**：Agent 需要存取外部服務（API、資料庫）時超時。

**原因**：
- 網路延遲
- 外部服務回應慢
- 連線數過多

**解決方案**：
1. 檢查網路連線
2. 使用 mock 代替真實外部服務
3. 增加外部服務連線池

### 場景 3：無限迴圈

**狀況**：Agent 執行中陷入無限迴圈。

**原因**：
- 程式碼邏輯錯誤
- 遞迴沒有正確終止條件

**解決方案**：
1. 使用 `--debug` 模式查看執行日誌
2. 檢查最近的程式碼變更
3. 添加迴圈保護機制

## 快速修復

### 方法 1：增加超時限制

如果任務確實需要較長時間，可以增加超時限制：

```bash
/multi-orchestrate --agent-timeout 600 "任務描述"
```

這會將超時限制增加到 10 分鐘。

### 方法 2：重試執行

有時候超時是暫時性的，簡單重試即可：

```bash
/multi-orchestrate --resume {workflow-id}
```

### 方法 3：跳過問題視角

如果特定視角持續超時，可以暫時跳過：

```bash
/multi-orchestrate --skip-perspective {perspective-id} "任務描述"
```

## 深入分析

### 診斷步驟

1. **確認超時視角**

   查看錯誤訊息中的 `perspective` 欄位。

2. **檢查執行日誌**

   ```bash
   /multi-orchestrate --debug --resume {workflow-id}
   ```

3. **分析資源使用**

   檢查是否有 CPU 或記憶體異常。

4. **檢查外部依賴**

   確認所有外部服務正常運作。

### 預設超時配置

| 階段 | 預設超時 | 說明 |
|------|----------|------|
| RESEARCH | 300s | 研究任務 |
| PLAN | 300s | 規劃任務 |
| IMPLEMENT | 300s | 實作任務（每視角） |
| REVIEW | 300s | 審查任務 |
| VERIFY | 300s | 驗證任務 |

### 自訂超時

可以在配置中自訂超時：

```yaml
# .claude/config/workflow.yaml
agent_timeout:
  default: 300
  by_perspective:
    tdd-enforcer: 600
    performance-optimizer: 450
```

## 預防措施

### 1. 任務分解

將大型任務分解為更小的單元，減少單次執行時間。

### 2. 使用 Mock

在測試中使用 mock 代替真實的外部服務。

### 3. 監控執行時間

定期檢查各視角的平均執行時間，及早發現潛在問題。

### 4. 設定合理的超時

根據歷史數據設定合理的超時限制，而非使用預設值。

## 相關錯誤

- [E-AGT-005](./E-AGT-005.md) - Agent 崩潰
- [E-AGT-007](./E-AGT-007.md) - Agent 重試失敗
- [E-ENV-004](./E-ENV-004.md) - 網路錯誤

## 參考資料

- [錯誤碼定義](../../shared/errors/error-codes.md)
- [進度顯示模組](../../shared/progress/display.md)
