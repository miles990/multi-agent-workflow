# Map Phase（共用模組）

> 並行執行階段：多 Agent 同時處理不同視角/任務

## 概述

Map Phase 是多 Agent 工作流的核心階段，透過 Task API 啟動多個並行 Agent，每個 Agent 負責一個視角的專門工作。

**此為共用模組**，被以下 skill 引用：
- `skills/research/` - 多視角研究
- `skills/plan/` - 多視角規劃
- `skills/implement/` - 監督式實作
- `skills/review/` - 多視角審查
- `skills/verify/` - 多視角驗證

## 執行流程

```
┌─────────────────────────────────────────────────────────────────┐
│  準備階段                                                        │
│  1. 載入視角配置（由各 skill 提供）                              │
│  2. 為每個視角生成專屬 prompt                                    │
│  3. 準備 Task API 呼叫                                           │
└─────────────────────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────────────────────┐
│  並行啟動                                                        │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Task #1        Task #2        Task #3        Task #4     │   │
│  │ (視角 A)       (視角 B)       (視角 C)       (視角 D)    │   │
│  │                                                           │   │
│  │ 各 Agent 獨立運作，互不干擾                               │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────────────────────┐
│  同步檢查點（可選）                                              │
│  S1 (50%): 確認方向正確                                          │
│  S2 (80%): 驗證初步成果                                          │
└─────────────────────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────────────────────┐
│  收集結果                                                        │
│  等待所有 Task 完成，收集視角報告                                │
└─────────────────────────────────────────────────────────────────┘
```

## Task API 呼叫模式

### 並行啟動

```javascript
// 概念示意（實際使用 Claude Code Task tool）
const tasks = perspectives.map(perspective => ({
  description: `${perspective.name} 處理 ${topic}`,
  prompt: generatePrompt(perspective, topic, config),
  subagent_type: selectAgentType(perspective)
}))

// 並行執行所有 Task
await Promise.all(tasks.map(task => executeTask(task)))
```

### Agent 類型選擇

| 視角類型 | subagent_type | 適用場景 |
|----------|---------------|----------|
| 探索型 | `Explore` | 需要搜尋程式碼/檔案 |
| 分析型 | `general-purpose` | 深度思考分析 |
| 規劃型 | `Plan` | 需要設計實作計劃 |

### 通用 Prompt 結構

```markdown
## 任務

你是一位 {角色描述}。

### 主題/目標
{topic}

### 你的聚焦領域
{focus_points}

### 輸出要求
請產出一份結構化報告：

1. **核心發現/建議**（3-5 點）
2. **詳細分析**
3. **建議與洞察**
4. **風險/注意事項**（如適用）

### 格式
使用 Markdown 格式，清晰分段
```

## 同步檢查點

### S1: 進度確認 (50%)

**目的**：確保方向正確

檢查項目：
- [ ] Agent 正在處理正確的主題
- [ ] 深度符合預期
- [ ] 沒有偏離核心問題

如果偏離：
- 終止該 Agent
- 調整 prompt
- 重新啟動

### S2: 成果驗證 (80%)

**目的**：確認初步成果的品質

檢查項目：
- [ ] 發現/建議有足夠支持
- [ ] 結論合理
- [ ] 可以進入整合階段

## 失敗處理

### Agent 超時

```
如果 Agent 超過預期時間：
1. 記錄已有的部分結果
2. 標記為「部分完成」
3. 繼續整合流程（降級處理）
```

### Agent 錯誤

```
如果 Agent 回報錯誤：
1. 記錄錯誤類型
2. 嘗試一次重啟（相同配置）
3. 如仍失敗，使用備用視角或跳過
```

## 並行度控制

| 模式 | 並行 Agent 數 | 適用場景 |
|------|--------------|---------|
| quick | 2 | 快速處理 |
| normal | 4 | 標準處理 |
| deep | 6 | 深度處理 |

### 記憶體考量

每個 Agent 獨立運作，不共享上下文。這確保：
- 視角獨立性（不互相影響）
- 資源隔離（一個失敗不影響其他）
- 可擴展性（可輕易增加視角數）

## 配置參數

各 skill 可透過配置客製化 Map Phase：

```yaml
map_config:
  parallelism: 4              # 並行度
  timeout_minutes: 10         # 單一 Agent 超時
  checkpoints:
    enabled: true             # 是否啟用同步檢查點
    s1_threshold: 0.5         # S1 觸發點
    s2_threshold: 0.8         # S2 觸發點
  retry:
    max_attempts: 2           # 最大重試次數
    on_failure: skip          # 失敗策略：skip | abort | fallback
```

## 下一步

Map Phase 完成後，進入 [Reduce Phase](./reduce-phase.md) 進行整合。
