# Map Phase

> 並行研究階段：多 Agent 同時探索不同視角

## 概述

Map Phase 是研究框架的核心階段，透過 Task API 啟動多個並行 Agent，每個 Agent 負責一個視角的深度研究。

## 執行流程

```
┌─────────────────────────────────────────────────────────┐
│  準備階段                                               │
│  1. 載入視角配置                                        │
│  2. 為每個視角生成專屬 prompt                           │
│  3. 準備 Task API 呼叫                                  │
└─────────────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────────────┐
│  並行啟動                                               │
│  ┌──────────────────────────────────────────────────┐  │
│  │ Task #1        Task #2        Task #3       ...  │  │
│  │ (架構分析師)   (認知研究員)   (工作流設計師)     │  │
│  │                                                   │  │
│  │ 各 Agent 獨立運作，互不干擾                       │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────────────┐
│  同步檢查點                                             │
│  S1 (50%): 確認研究方向正確                             │
│  S2 (80%): 驗證初步發現                                 │
└─────────────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────────────┐
│  收集結果                                               │
│  等待所有 Task 完成，收集視角報告                       │
└─────────────────────────────────────────────────────────┘
```

## Task API 呼叫模式

### 並行啟動

```javascript
// 概念示意（實際使用 Claude Code Task tool）
const tasks = perspectives.map(perspective => ({
  description: `${perspective.name} 研究 ${topic}`,
  prompt: generatePrompt(perspective, topic),
  subagent_type: perspective.method === 'search' ? 'Explore' : 'general-purpose'
}))

// 並行執行所有 Task
await Promise.all(tasks.map(task => executeTask(task)))
```

### 單一視角 Prompt 結構

```
## 研究任務

你是一位 {視角角色}。

### 研究主題
{topic}

### 你的研究重點
{focus_points}

### 輸出要求
請產出一份結構化報告：

1. **核心發現**（3-5 點）
2. **詳細分析**
3. **建議與洞察**
4. **相關資源**（如適用）

### 格式
使用 Markdown 格式，清晰分段
```

## 同步檢查點

### S1: 進度確認 (50%)

目的：確保研究方向正確

檢查項目：
- [ ] Agent 正在研究正確的主題
- [ ] 研究深度符合預期
- [ ] 沒有偏離核心問題

如果偏離：
- 終止該 Agent
- 調整 prompt
- 重新啟動

### S2: 發現驗證 (80%)

目的：確認初步發現的品質

檢查項目：
- [ ] 發現有足夠支持證據
- [ ] 結論合理
- [ ] 可以進入整合階段

## 失敗處理

### Agent 超時

```
如果 Agent 超過預期時間：
1. 記錄已有的部分結果
2. 標記為「部分完成」
3. 繼續整合流程（降級處理）
```

### Agent 錯誤

```
如果 Agent 回報錯誤：
1. 記錄錯誤類型
2. 嘗試一次重啟（相同配置）
3. 如仍失敗，使用備用視角或跳過
```

## 資源管理

### 並行度控制

| 模式 | 並行 Agent 數 | 適用場景 |
|------|--------------|---------|
| quick | 2 | 快速研究 |
| normal | 4 | 標準研究 |
| deep | 6 | 深度研究 |

### 記憶體考量

每個 Agent 獨立運作，不共享上下文。這確保：
- 視角獨立性（不互相影響）
- 資源隔離（一個失敗不影響其他）
- 可擴展性（可輕易增加視角數）

## 輸出格式

每個 Agent 完成後產出：

```
.claude/memory/research/[topic-id]/perspectives/
├── architecture.md    # Agent #1 輸出
├── cognitive.md       # Agent #2 輸出
├── workflow.md        # Agent #3 輸出
└── industry.md        # Agent #4 輸出
```

## 下一步

Map Phase 完成後，進入 [Reduce Phase](./reduce-phase.md) 進行整合。
